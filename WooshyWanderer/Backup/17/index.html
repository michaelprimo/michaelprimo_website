<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="style.css">
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, minimum-scale=1, width=device-width, height=device-height">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"> 

</head>
<body>

<canvas id="game" width="240" height="135"></canvas>
<script>

let canvas = document.querySelector('canvas');
let ctx = canvas.getContext('2d');
const FONT_NAME = 'Press Start 2P';
let img = new Image();
img.src = 'Image/Biplane.png';

var img1 = new Image();
img1.src = "Image/bluefrog.png";

var img2 = new Image();
img2.src = "Image/whitefrog.png";
// Our images array
var images = [img1, img2];
let angle = 45;
let radians = angle * Math.PI / 180;

let points = 0;
let iFrame = 0;
let iFrame_max = 1000; 
let lives = 3;
let bombs = 3;

let gotHit = false;
const scale = 1;
const width = 15;
const height = 15;
const scaledWidth = scale * width;
const scaledHeight = scale * height;
let playerY = canvas.height/2;
let playerX = canvas.width/2;
// Keys states (false: key is released / true: key is pressed)
up = right = down = left = false;
let speed = 0;
let pause = false;
// spawn a new object every 1500ms
var minSpawnRate = 1000;
var maxSpawnRate = 500;
var reduceSpawnRate = 1;
var spawnRate = Math.round(Math.random() * minSpawnRate) + maxSpawnRate;

// when was the last object spawned
var lastSpawn = Date.now() + 3000;

// this array holds all spawned object
var objects = [];

// save the starting time (used to calc elapsed time)
var startTime = Date.now();

var directionSpawn = ["down", "up", "right", "left"];

img.onload = function() {
  init();
};


function init() {
  window.requestAnimationFrame(step);
}


function step() {
	movePlayer();
  frameCount++;
  if (frameCount < 2) {
    window.requestAnimationFrame(step);
    return;
  }
  frameCount = 0;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
	let colors = "#1D1C1F";
  ctx.fillStyle = colors;
  ctx.fillRect(0,0,canvas.width,canvas.height);
	

let animationFrames = [0,1,2,3,4,3,2,1];
  drawFrame(animationFrames[currentLoopIndex], Math.round(playerX),  Math.round(playerY));
  currentLoopIndex++;
  if (currentLoopIndex >= animationFrames.length) 
  {
    currentLoopIndex = 0;
  }
  window.requestAnimationFrame(step);
}

function renderText() 
{ 
    ctx.fillStyle = "#fff";
    ctx.font = `8px "${FONT_NAME}"`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText("L x " + lives, Math.round(canvas.width/5), 15);
    ctx.fillText("P x " + points, Math.round(canvas.width/2), 15);
    ctx.drawImage(img2,
                45, 45, width, height,
                Math.round(canvas.width/2+canvas.width/5), 7, width, height);
    ctx.fillText("x " + bombs, Math.round(canvas.width/2+canvas.width/3), 15);
    if(lives <= 0)
    {
      ctx.fillText("GAME OVER", Math.round(canvas.width/2), Math.round(canvas.height/2));
      pause = true;
    }
}


function spawnRandomObject() {

    // create the new object
    var object1 = {
        // set this objects type
        type: 0,

        width: 15,

        height: 15,

        direction: Math.round(Math.random() * 3),

		    spawnRateOfDescent: Math.random() * 1 + 0.5,
        // set x randomly but at least 15px off the canvas edges
        x: 0,
        // set y to start on the line where objects are spawned
        y: 0,
        // give random image
        image: images[0],

        imageFrame: 0
    }

    let selectType = Math.random() * 100;
    
    if(selectType >= 85)
    {
      object1.type = 1;
      object1.image = images[1];
      object1.spawnRateOfDescent += 0.5;
    }
    else
    {
      object1.type = 0;
      object1.image = images[0];
    }

    switch(object1.direction)
    {
      case 0: 
        object1.x = Math.random() * (canvas.width - 20) + 10;
        object1.y = 15;
        break;
      case 1: 
        object1.x = Math.random() * (canvas.width - 20) + 10;
        object1.y = canvas.height-15;
        break;
      case 2: 
        object1.x = canvas.width-15;
        object1.y = Math.random() * (canvas.height - 20) + 10;
        break;
      case 3: 
        object1.x = 15;
        object1.y = Math.random() * (canvas.height - 20) + 10;
        break;
    }

    objects.push(object1);
}

let frameEnemyCount = 0;

function animate() {

    // get the elapsed time
    var time = Date.now();

    // see if its time to spawn a new object
    if (time > (lastSpawn + spawnRate) && pause == false) {
        lastSpawn = time;
        spawnRandomObject();
        if(minSpawnRate > 0)
        {
          minSpawnRate -= reduceSpawnRate;
        }
        spawnRate = Math.round(Math.random() * minSpawnRate) + maxSpawnRate;
        console.log("spawnRate = " + spawnRate + " minSpawnRate = " + minSpawnRate);
    }

    // request another animation frame
    requestAnimationFrame(animate);

    for (var i = 0; i < objects.length; i++) {
        var object = objects[i];
    
    if(pause == true)
    {
      object.spawnRateOfDescent = 0;
    }

		if(object.y < canvas.height && object.direction === 0)
		{
			object.y += object.spawnRateOfDescent;
		}
    if(object.y < canvas.height && object.direction === 1)
		{
			object.y -= object.spawnRateOfDescent;
		}
    if(object.x < canvas.width && object.direction === 2)
		{
			object.x -= object.spawnRateOfDescent;
		}
    if(object.x < canvas.width && object.direction === 3)
		{
			object.x += object.spawnRateOfDescent;
		}
    if(object.x > canvas.width || object.x < 0 || object.y > canvas.height || object.y < 0)
		{
			objects.splice(i, 1);
		}
    if(frameEnemyCount > 5)
    {
      if(object.imageFrame < 3)
      {
        object.imageFrame++;
      }
      else
      {
        object.imageFrame = 0;
      }
      frameEnemyCount = 0;
    }
    else
    {
      frameEnemyCount++;
    }
    if(iFrame > 0)
    {
      iFrame--;
      gotHit = true;  
      console.log(gotHit);
    }
    
      
    if(lives > 0)
    {
      points += 1;
    }
    
        ctx.drawImage(object.image, object.width*object.imageFrame,object.height*object.direction,object.width,object.height,Math.round(object.x), Math.round(object.y), object.width, object.height);
        if (playerX < object.x + object.width &&
   playerX + object.width > object.x &&
   playerY < object.y + object.height &&
   playerY + height > object.y && object.type == 0 && lives > 0) 
   {
   
   if(iFrame == 0)
   {
    gotHit = false;
    console.log(gotHit);
    iFrame = iFrame_max;
    lives--;

   }
    
  }
  else if (playerX < object.x + object.width &&
   playerX + object.width > object.x &&
   playerY < object.y + object.height &&
   playerY + height > object.y && object.type == 1) 
   {
   bombs++;
   objects.splice(i, 1);
   }
    }
    
}


/*
function drawEnemyFrame(imageFrame)
{
  if(imageFrame < 4)
  {
    return imageFrame++;
  }
  else
  {
    return imageFrame = 0;
  }
  setTimeout(drawEnemyFrame, 500);
}
*/


// Keydown listener
onkeydown = (e) => {
  if(pause == false)
  {
    speed = 1.5;
  }
  else
  {
    speed = 0;
  }
  // Up (up / W / Z)
  if(e.keyCode == 38 || e.keyCode == 90 || e.keyCode == 87){
    up = true;
  }
  
  // Right (right / D)
  if(e.keyCode == 39 || e.keyCode == 68){
	
    right = true;
  }
  
  // Down (down / S)
  if(e.keyCode == 40 || e.keyCode == 83){
    down = true;
  }
  
  // Left (left / A / Q)
  if(e.keyCode == 37 || e.keyCode == 65 ||e.keyCode == 81){
    left = true;
  }
 
}

// Keyup listener
onkeyup = (e) => {

  // Up
  if(e.keyCode == 38 || e.keyCode == 90 || e.keyCode == 87){
    up = false;
  }
  
  // Right
  else if(e.keyCode == 39 || e.keyCode == 68){
    right = false;
  }
  
  // Down
  else if(e.keyCode == 40 || e.keyCode == 83){
    down = false;
  }
  
  // Left
  else if(e.keyCode == 37 || e.keyCode == 65 || e.keyCode == 81){
    left = false;
  }
  
}

function movePlayer()
{
	if(up==false&&down==false&&right==false&&left==false)
  {
	  speed = 0;
  }
	if(down == true && right == true)
	{
		angle = 315;
	}
	else if(down == true && left == true)
	{
		angle = 225;
	}
	else if(down == true)
	{
		angle = 270;
	}
	else if(up == true && right == true)
	{
		angle = 45;
	}
	else if(up == true && left == true)
	{
		angle = 135;
	}
	else if(up == true)
	{
		angle = 90;
	}
	
	
	else if(right == true)
	{
		angle = 0;

	}
	else if(left == true)
	{
		angle = 180;

	}
	radians = (360 - angle) * Math.PI / 180;
  
  if(playerX <= canvas.width-15)
  {
    playerX += Math.cos(radians) * speed;
  }
  else
  {
    playerX = canvas.width-15;
  }
  if(playerX <= 0)
  {
    playerX = 0;
  }
 
  if(playerY <= canvas.height-15)
  {
	  playerY += Math.sin(radians) * speed;
  }
  else
  {
    playerY = canvas.height-15;
  }
  if(playerY <= 0)
  {
	  playerY = 0;
  }
	
}

var frequency = 200;


function drawFrame(frameX, canvasX, canvasY) {
  if(! gotHit || Math.floor(Date.now() / frequency) % 2)
  {
    ctx.drawImage(img,
                frameX * width, 0, width, height,
                canvasX, canvasY, scaledWidth, scaledHeight);
  }

  
  renderText();
  
}

let currentLoopIndex = 0;
let frameCount = 0;




// start animating
window.onload=function(){
animate();
}
</script>
</body>
</html>
